<!DOCTYPE html>
<html lang="es">
<head>
<title>Simalga Maps</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link  rel="icon" href="{{ url_for('static', filename= 'img/favicon.png') }}" type="image/png" />
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
<script src="{{ url_for('static', filename= 'js/h.js') }}"></script>
<script src="{{ url_for('static', filename= 'js/cs.js') }}"></script>
<style>
#map { width: 70vw ;
	 height: 98vh; }
.info { padding: 6px 8px;
		font: 14px/16px;
		background: white;
		background: rgba(255,255,255,0.8);
		box-shadow: 0 0 15px rgba(0,0,0,0.2);
		border-radius: 5px; }
.info h4 { margin: 0 0 5px;
			color: #777; }
.legend { 	text-align: left;
			line-height: 18px;
			color: #555; }
.legend i { width: 18px;
			height: 18px;
			float: left;
			margin-right: 8px;
			opacity: 0.7; }
			
.wrapper {
  display: flex;  
  flex-flow: row wrap;
  font-weight: bold;
  text-align: center; 
}

.wrapper > * {
  
  flex: 1 100%;
}

.header {
text-align: left;

}

.footer {

}

.main {
  text-align: left;
}

.aside-1 {
  background: gold;
}

.aside-2 {
	color:DarkSlateGrey;
}

@media all and (min-width: 600px) {
  .aside { flex: 1 0 0; }
}

@media all and (min-width: 800px) {
  .main    { flex: 3 0px; }
  .aside-1 { order: 1; } 
  .main    { order: 2; }
  .aside-2 { order: 3; }
  .footer  { order: 4; }
}

body {
  padding: 0.5em; 
}
a {
	font:Arial rounded;
	cursor: pointer
}
td {
	font-color:Darkgrey
}
nav {
	
	
}
.nav-link{
	text-color:DarkGoldenRod;
}
.btn-group.special {
  display: flex;
}

.special .btn {
  flex: 1
}
</style>
</head>
<body>
<div class="wrapper">
  <article class="main">
	  <div id='map'></div>
 </article>
<aside class="aside aside-2">
      <table class="table-responsive-sm">
    <thead>
	 <tr>
		<td><img src="{{ url_for('static', filename= 'img/banderard.png') }}" class="img-fluid"  alt="logo_simalga" style="max-width:100%"></td>
        <td><img src="{{ url_for('static', filename= 'img/sns.png') }}" class="img-fluid"  alt="logo_simalga" style="max-width:100%"></td>
 </tr>
      <tr>
        <th id="nombre" colspan=2>REPÚBLICA DOMINICANA</th>
      </tr>
    </thead>
    <tbody>
		<tr><td colspan=2><br></td></tr>
      <tr>
        <td style="text-align:left"><i class='fas fa-users' style='font-size:24px'></i> Población </td>
        <td style="text-align:right"><span id="hab">10.358.000</span> hab.</td>
      </tr>
      <tr><td colspan=2><br></td></tr>
      <tr>
<td style="text-align:left"><i class='fas fa-hospital' style='font-size:24px'></i> Hospitales </td>
<td style="text-align:right"><span id="hosp">187</span></td>
      </tr>
      <tr><td colspan=2><br></td></tr>
      <tr>
<td style="text-align:left"><i class='fas fa-medkit' style='font-size:24px'></i> Centros </td>
<td style="text-align:right"><span id="cs">1630</span><small>(1<sup>er</sup> nivel)</small> </td>
      </tr>
      <tr><td colspan=2><br></td></tr>
      <tr>
<td style="text-align:left"><i class='fas fa-hospital'></i>/<i class='fas fa-users'></i> Tasa Hosp/Hab.</td>
<td style="text-align:right"><span id="th">1.80536</span><small> hosp. por 100.000 hab.</small></td>
      </tr>
      <tr><td colspan=2><br></td></tr>
      <tr>
<td style="text-align:left"><i class='fas fa-medkit'></i>/<i class='fas fa-users'></i> Tasa <br> C.S./Hab.</td>
<td style="text-align:right"><span id="tcs">1.57366</span><small> CS. por 10.000 hab</small></td>
      </tr>
      <tr><td colspan=2><br></td></tr>
<tr>
<td colspan=2 style="text-align:left">
<div class="btn-group special">
  <button id="regiones" type="button" class="btn btn-outline-dark">Regiones</button>
  <button id="provincias" type="button" class="btn btn-outline-dark">Provincias</button>
  <button id="municipios" type="button" class="btn btn-outline-dark">Municipios</button>
    <button id="reset" type="button" class="btn btn-outline-dark">Reset</button>
</div>
</td>
</tr>
      <tr>
<td colspan=2 style="text-align:left">
<button id="tasa" type="button" class="btn btn-outline-dark btn-block">Colores por Tasa Hospital/hab.</button>
</td>
      </tr>
<tr>
<td colspan=2 style="text-align:left">
<div class="btn-group special">
  <button id="" type="button" class="btn btn-outline-dark"> 
          <div class="form-check-inline">
      <label class="form-check-label" for="chkhosp">
        <input type="checkbox" class="form-check-input" id="chkhosp" name="vehicle1" value="something">Hospitales
      </label>
    </div>
  </button>
  <button id="" type="button" class="btn btn-outline-dark"> 
          <div class="form-check-inline">
      <label class="form-check-label" for="chkcs">
        <input type="checkbox" class="form-check-input" id="chkcs" name="vehicle1" value="something">C.Salud
      </label>
    </div>
  </button>
</div>
</td>
</tr>
      <tr>
<td colspan=2><button  type="button" class="btn btn-outline-dark btn-block"><i class='fas fa-file-word' style="color:DarkSlateBlue"></i><a id="informe" href="informe"> Descargar informe de zona</a></button>
</td>
      </tr>
    </tbody>
  </table>
</aside>
  <footer class="footer"><p style="color:DarkKhaki" >
	  <small>© 2021 Simalga Internacional- Todos los derechos reservados</small></p>
	  </footer>
</div>
<script>
	$(document).ready(function(){
	informe = "informe";
	var actual = ["","",""];
	var map = L.map('map').setView([18.88055,-70.11079], 7.5);

	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Simalga Internacional Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/light-v9',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(map);


// control that shows state info on hover
	var info = L.control();

	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info');
		this.update();
		return this._div;
	};

	info.update = function (props) {
		this._div.innerHTML = '<h4>Datos</h4>' +  (props ?
			'<table><tr><td>'+props.tipo +'</td><td></td><td style="text-align:right"><b>' + props.nombre + '</b></td></tr><tr><td>Población</td><td></td><td style="text-align:right"><b>' + props.poblacion + '</b> hab </td></tr><tr><td>Nº hospitales</td><td></td><td style="text-align:right"><b>'+ props.hospital +'</b></td></tr><tr><td>Nº centros 1er nivel</td><td></td><td style="text-align:right"><b>'+ props.centro_1_nivel +'</b></td></tr><tr><td>Tasa de hospitales (cien mil hab.)</td><td></td><td style="text-align:right"><b>'+ props.tasa_hospital +'</b></td></tr><tr><td>Tasa de centros 1er nivel (cien mil hab.)</td><td></td><td style="text-align:right"><b>'+ props.tasa_centro_1_nivel +'</b></td></tr></table>'
			: 'Deslice el ratón');
	};

	info.addTo(map);

	// get color depending on population density value
	function getColor(d) {
		if (actual[1]==""){
		return d > 6 ? 'DarkGreen' :
				d > 3  ? 'ForestGreen' :
				d > 1  ? 'DarkGoldenRod' :
				d > 0  ? 'Coral' :
				d < 1   ? 'DarkRed' :
							'#FFEDA0';
		}
		if (actual[1]=="tcs"){
		return d > 3 ? 'DarkGreen' :
				d > 2  ? 'ForestGreen' :
				d > 1  ? 'DarkGoldenRod' :
				d > 0  ? 'Coral' :
				d < 1   ? 'DarkRed' :
							'#FFEDA0';
		}
	}

	function style(feature) {
		if (actual[1]==""){
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.5,
			fillColor: getColor(feature.properties.tasa_hospital)
		}
		}
		if (actual[1]=="tcs"){
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.5,
			fillColor: getColor(feature.properties.tasa_centro_1_nivel)
		}
		};
	}
	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 5,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.1
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
	}
	var capa;
	function resetHighlight(e) {
		capa.resetStyle(e.target);
		info.update();
	}

	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
		a = e.target.feature.properties.nombre;
		console.log(a);
		b = e.target.feature.properties.tipo;
		console.log(b);
		
		if (b == "region") {c = "provincias"; mas = "SERVICIO REGIONAL DE SALUD ";  $("#informe").attr("href","informe/region/"+a);}
		if (b == "provincia") {c = "municipios"; mas = "PROVINCIA DE "; $("#informe").attr("href","informe/provincia/"+a);}
		if (b == "municipios") {mas = "Municipio de ";}
		$("#nombre").text(mas+a);
		$("#hab").text(e.target.feature.properties.poblacion);
		$("#hosp").text(e.target.feature.properties.hospital);
		$("#cs").text(e.target.feature.properties.centro_1_nivel);
		$("#th").text(e.target.feature.properties.tasa_hospital);
		$("#tcs").text(e.target.feature.properties.tasa_centro_1_nivel);
		if (b !="municipios"){
			url = c+"/"+a;
			capa.remove();
			actual[0] = url;
			console.log(actual[0]);
			carga(url);}
	}

	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomToFeature,
		});
	}


	var url="regiones";
	actual[0] = url;
	console.log(actual[0]);
	carga(url);
    $("#regiones").click(function(){
	capa.remove();
	url = "regiones";
	actual[0] = url;
	console.log(actual[0]);
	carga(url);
  });
    $("#provincias").click(function(){
	capa.remove();
	url = "provincias";
	actual[0] = url;
	console.log(actual[0]);
	carga(url);
  });
    $("#municipios").click(function(){
	capa.remove();
	url = "municipios";
	actual[0] = url;
	console.log(actual[0]);
	carga(url);
  });
    $("#reset").click(function(){
	actual[0] = "";
	console.log(actual[0]);
	capa.remove();
	show_cs.remove();
	show_hospital.remove();
  });
  	function carga(url){
    $.ajax({url: url, success: function(result){
      $("#div1").html(result);
      data = JSON.parse(result);
      console.log(data);
      capa= L.geoJSON(data,{style: style,onEachFeature: onEachFeature}).addTo(map);
  }
  });
}

var legend = L.control({position: 'bottomright'});
var legendB = L.control({position: 'bottomright'});


legend.onAdd = function (map) {

    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1, 3, 6],
        labels = [];

    // loop through our density intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
    }

    return div;
};
legendB.onAdd = function (map) {

    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1, 2, 3],
        labels = [];

    // loop through our density intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
    }

    return div;
};
$("#tasa").click(function(){
	if (actual[1] == ""){
		actual[1] = "tcs";
		capa.remove();
		legend.remove();
		carga(actual[0]);
		legendB.addTo(map);
		$("#tasa").text("Colores por tasa C.S / Hab.");
	}
	else {
		actual[1] = "";
		capa.remove();
		legendB.remove();
		carga(actual[0]);
		legend.addTo(map);
		$("#tasa").text("Colores por tasa Hosp. / Hab.");
	}
});

legend.addTo(map);
if (actual[1] == "tcs"){
legendB.addTo(map);}

L.Control.Watermark = L.Control.extend({
    onAdd: function(map) {
        var img = L.DomUtil.create('img');

        img.src = "{{ url_for('static', filename= 'img/logo.png') }}";
        img.style.width = '250px';

        return img;
    },

    onRemove: function(map) {
        // Nothing to do here
    }
});

L.control.watermark = function(opts) {
    return new L.Control.Watermark(opts);
}

L.control.watermark({ position: 'bottomleft' }).addTo(map);
var myIcon_h = L.icon({
  iconUrl: "{{ url_for('static', filename= 'img/hospital_marker.png') }}",
  iconSize: [25, 25],
  iconAnchor: [16, 37],
  popupAnchor: [0, -28]
});

function onEachFeature_h(feature, layer) {
	console.log(feature.properties)
  layer.bindPopup('Centro:'+feature.properties.nombre+'<br>Dirección:'+feature.properties.direccion+'<br>Telefono:'+feature.properties.telefono+'<br>email:'+feature.properties.email);
}

var show_hospital = L.geoJSON(hospitales, {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: myIcon_h});
    },
  onEachFeature: onEachFeature_h
});
$("#chkhosp").change(function() {
                    if ($("#chkhosp").is(
                      ":checked")) {
                        show_hospital.addTo(map);
                    } else {
                        show_hospital.remove();
                    }
                });
var myIcon_cs = L.icon({
  iconUrl: "{{ url_for('static', filename= 'img/cs_marker.png') }}",
  iconSize: [25, 25],
  iconAnchor: [16, 37],
  popupAnchor: [0, -28]
});

function onEachFeature_cs(feature, layer) {
	console.log(feature.properties)
  layer.bindPopup('Centro:'+feature.properties.nombre+'<br>Dirección:'+feature.properties.direccion+'<br>Telefono:'+feature.properties.telefono+'<br>email:'+feature.properties.email);
}

var show_cs = L.geoJSON(cs, {
  pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: myIcon_cs});
    },
  onEachFeature: onEachFeature_cs
});
$("#chkcs").change(function() {
                    if ($("#chkcs").is(
                      ":checked")) {
                        show_cs.addTo(map);
                    } else {
                        show_cs.remove();
                    }
                });
  });


	

</script>



</body>
</html>
